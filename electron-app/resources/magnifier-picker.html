<!doctype html>
<html>
  <head>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: transparent;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        cursor: none;
        user-select: none;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
      }

      .overlay-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        cursor: none;
        pointer-events: none;
      }

      .magnifier-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 200px;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: none;
        pointer-events: none;
        will-change: transform;
        transform: translate(0px, 0px);
      }

      .magnifier-circle {
        position: relative;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        border: 4px solid #ffffff;
        box-sizing: content-box;
        overflow: hidden;
        background: #000;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        flex-shrink: 0;
        transition:
          width 0.2s ease-out,
          height 0.2s ease-out;
      }

      .pixel-grid {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        display: grid;
        grid-template-columns: repeat(9, 1fr);
        grid-template-rows: repeat(9, 1fr);
      }

      .pixel {
        outline: 1px solid rgba(128, 128, 128, 0.4);
        outline-offset: -1px;
      }

      .pixel.center {
        border: 3px solid #ffffff;
        box-shadow:
          0 0 6px #000000,
          inset 0 0 4px rgba(255, 255, 255, 0.8);
        z-index: 10;
        position: relative;
      }

      .color-label {
        position: absolute;
        top: 50px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 9px;
        font-family: Monaco, Consolas, monospace;
        pointer-events: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        z-index: 20;
        max-width: 80px;
        display: flex;
        gap: 4px;
      }

      .color-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex-shrink: 1;
        min-width: 0;
      }

      .colon {
        flex-shrink: 0;
      }

      .hex-code {
        flex-shrink: 0;
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div class="overlay-container">
      <div class="magnifier-container" id="magnifierContainer">
        <div class="magnifier-circle">
          <div class="pixel-grid" id="pixelGrid"></div>
        </div>
        <div class="color-label" id="colorLabel">
          <span class="color-name" id="colorName">Color</span>
          <span class="colon">:</span>
          <span class="hex-code" id="hexCode">#FFFFFF</span>
        </div>
      </div>
    </div>

    <script>
      const magnifierContainer = document.getElementById("magnifierContainer");
      const magnifierCircle = document.querySelector(".magnifier-circle");
      const pixelGrid = document.getElementById("pixelGrid");
      const colorName = document.getElementById("colorName");
      const hexCode = document.getElementById("hexCode");

      let currentGridSize = 9;
      let currentDiameter = 150;

      // Throttle wheel events to prevent rapid fire zooming
      let lastWheelTime = 0;
      const WHEEL_THROTTLE_MS = 100;

      function createPixelGrid(gridSize) {
        currentGridSize = gridSize;
        const totalPixels = gridSize * gridSize;
        const centerIndex = Math.floor(totalPixels / 2);

        pixelGrid.innerHTML = "";
        pixelGrid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
        pixelGrid.style.gridTemplateRows = `repeat(${gridSize}, 1fr)`;

        for (let i = 0; i < totalPixels; i++) {
          const pixel = document.createElement("div");
          pixel.className = "pixel";
          pixel.id = `pixel-${i}`;

          if (i === centerIndex) {
            pixel.className += " center";
          }

          pixelGrid.appendChild(pixel);
        }
      }

      function updateMagnifierSize(diameter) {
        currentDiameter = diameter;
        // Ensure both dimensions are identical for a perfect circle
        magnifierCircle.style.width = `${diameter}px`;
        magnifierCircle.style.height = `${diameter}px`;
        magnifierCircle.style.minWidth = `${diameter}px`;
        magnifierCircle.style.minHeight = `${diameter}px`;
        magnifierCircle.style.maxWidth = `${diameter}px`;
        magnifierCircle.style.maxHeight = `${diameter}px`;
      }

      createPixelGrid(9);
      window.magnifierAPI.send.ready();

      window.magnifierAPI.on.updatePosition((data) => {
        const displayX = data.displayX || 0;
        const displayY = data.displayY || 0;
        // Keep container offset fixed at 100px (half of initial 200px container)
        // The circle will be centered within the container via flexbox
        const offset = 100;
        const translateX = data.x - displayX - offset;
        const translateY = data.y - displayY - offset;

        magnifierContainer.style.transform = `translate(${translateX}px, ${translateY}px)`;
      });

      window.magnifierAPI.on.updatePixelGrid((data) => {
        const centerColor = data.centerColor;
        const currentColorName = data.colorName || "Unknown";
        colorName.textContent = currentColorName;
        hexCode.textContent = centerColor.hex.toUpperCase();

        // Update grid size if changed
        if (data.gridSize && data.gridSize !== currentGridSize) {
          createPixelGrid(data.gridSize);
        }

        // Update diameter if changed
        if (data.diameter && data.diameter !== currentDiameter) {
          updateMagnifierSize(data.diameter);
        }

        // Update pixel colors
        if (data.pixels && data.pixels.length === currentGridSize) {
          let pixelIndex = 0;
          for (let row = 0; row < currentGridSize; row++) {
            for (let col = 0; col < currentGridSize; col++) {
              const pixel = document.getElementById(`pixel-${pixelIndex}`);
              if (pixel && data.pixels[row] && data.pixels[row][col]) {
                pixel.style.backgroundColor = data.pixels[row][col].hex;
              }
              pixelIndex++;
            }
          }
        }
      });

      document.addEventListener("click", () => {
        window.magnifierAPI.send.colorSelected();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          window.magnifierAPI.send.cancelled();
        }
      });

      document.addEventListener(
        "wheel",
        (e) => {
          e.preventDefault();

          // Throttle wheel events to prevent rapid fire zooming
          const now = Date.now();
          if (now - lastWheelTime < WHEEL_THROTTLE_MS) {
            return;
          }
          lastWheelTime = now;

          const delta = e.deltaY > 0 ? -1 : 1;

          if (e.altKey) {
            window.magnifierAPI.send.zoomDensity(delta);
          } else {
            window.magnifierAPI.send.zoomDiameter(delta);
          }
        },
        { passive: false },
      );

      window.focus();
    </script>
  </body>
</html>
