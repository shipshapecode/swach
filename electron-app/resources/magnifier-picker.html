<!doctype html>
<html>
  <head>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: transparent;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        cursor: none;
        user-select: none;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
      }

      .overlay-container {
        /* Fullscreen transparent container */
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        cursor: none;
        pointer-events: none; /* Pass through events except on magnifier */
      }

      .magnifier-container {
        /* Absolutely positioned, moved via transform for smooth movement */
        position: absolute;
        top: 0;
        left: 0;
        width: 200px;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: none;
        pointer-events: none; /* Capture events on magnifier itself */
        will-change: transform; /* Performance hint for GPU acceleration */
        transform: translate(0px, 0px); /* Updated via JavaScript */
      }

      .magnifier-circle {
        position: relative;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        border: 4px solid #ffffff;
        box-sizing: content-box; /* Border outside the 150px, so grid is truly 150x150 */
        overflow: hidden;
        background: #000;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .pixel-grid {
        position: absolute;
        top: 0;
        left: 0;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        display: grid;
        grid-template-columns: repeat(9, 1fr);
        grid-template-rows: repeat(9, 1fr);
      }

      .pixel {
        /* Use outline instead of border so it doesn't affect grid cell size */
        outline: 1px solid rgba(128, 128, 128, 0.4);
        outline-offset: -1px;
      }

      .pixel.center {
        border: 3px solid #ffffff;
        box-shadow:
          0 0 6px #000000,
          inset 0 0 4px rgba(255, 255, 255, 0.8);
        z-index: 10;
        position: relative;
      }

      .color-label {
        position: absolute;
        top: 50px; /* Adjusted proportionally for 150px magnifier */
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 9px;
        font-family: Monaco, Consolas, monospace;
        pointer-events: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        z-index: 20;
        max-width: 80px;
        display: flex;
        gap: 4px;
      }

      .color-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex-shrink: 1;
        min-width: 0;
      }

      .colon {
        flex-shrink: 0;
      }

      .hex-code {
        flex-shrink: 0;
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div class="overlay-container">
      <div class="magnifier-container" id="magnifierContainer">
        <div class="magnifier-circle">
          <div class="pixel-grid" id="pixelGrid"></div>
        </div>
        <div class="color-label" id="colorLabel">
          <span class="color-name" id="colorName">Color</span>
          <span class="colon">:</span>
          <span class="hex-code" id="hexCode">#FFFFFF</span>
        </div>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");

      const magnifierContainer = document.getElementById("magnifierContainer");
      const pixelGrid = document.getElementById("pixelGrid");
      const colorLabel = document.getElementById("colorLabel");
      const colorName = document.getElementById("colorName");
      const hexCode = document.getElementById("hexCode");

      console.log("[Magnifier] Script loaded");

      // Create 9x9 grid of pixels (81 total)
      function createPixelGrid() {
        pixelGrid.innerHTML = "";
        for (let i = 0; i < 81; i++) {
          const pixel = document.createElement("div");
          pixel.className = "pixel";
          pixel.id = `pixel-${i}`;

          // Center pixel is at position 40 (5th row, 5th column in 0-indexed 9x9 grid: 4*9+4 = 40)
          if (i === 40) {
            pixel.className += " center";
          }

          pixelGrid.appendChild(pixel);
        }
      }

      createPixelGrid();

      // Signal ready
      ipcRenderer.send("magnifier-ready");

      // Listen for position updates from main process
      // This moves the magnifier UI smoothly via CSS transform
      ipcRenderer.on("update-magnifier-position", (event, data) => {
        // Position magnifier so CENTER SQUARE of 9x9 grid is at cursor
        // The window is positioned at display.bounds.x/y, so we need to
        // offset the cursor position relative to the window, not the screen

        // If display bounds are provided, adjust for multi-monitor
        const displayX = data.displayX || 0;
        const displayY = data.displayY || 0;

        // Magnifier is 200px, center is at 100px offset
        // Subtract display offset to get window-relative coordinates
        const translateX = data.x - displayX - 100;
        const translateY = data.y - displayY - 100;

        // Debug logging (only log occasionally to avoid spam)
        if (Math.random() < 0.05) {
          console.log(
            `[Magnifier] Cursor: (${data.x}, ${data.y}), Display: (${displayX}, ${displayY}), Translate: (${translateX}, ${translateY})` +
              `\n  Container will be at: (${translateX}, ${translateY}), center at: (${translateX + 100}, ${translateY + 100})`,
          );
        }

        // Use transform for hardware-accelerated smooth movement
        magnifierContainer.style.transform = `translate(${translateX}px, ${translateY}px)`;
      });

      // Listen for pixel grid updates
      ipcRenderer.on("update-pixel-grid", (event, data) => {
        try {
          // Update center color info
          const centerColor = data.centerColor;
          const currentColorName = data.colorName || "Unknown";
          colorName.textContent = currentColorName;
          hexCode.textContent = centerColor.hex.toUpperCase();

          // Update pixel grid with surrounding colors
          if (data.pixels && data.pixels.length === 9) {
            let pixelIndex = 0;
            for (let row = 0; row < 9; row++) {
              for (let col = 0; col < 9; col++) {
                const pixel = document.getElementById(`pixel-${pixelIndex}`);
                if (pixel && data.pixels[row] && data.pixels[row][col]) {
                  pixel.style.backgroundColor = data.pixels[row][col].hex;
                }
                pixelIndex++;
              }
            }
          }
        } catch (error) {
          console.error("[Magnifier] Error updating grid:", error);
        }
      });

      // Handle clicks
      document.addEventListener("click", (e) => {
        ipcRenderer.send("color-selected");
      });

      // Handle escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          ipcRenderer.send("picker-cancelled");
        }
      });

      window.focus();
    </script>
  </body>
</html>
