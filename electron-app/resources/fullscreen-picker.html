<!doctype html>
<html>
  <head>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        cursor: none;
        user-select: none;
      }

      #screenshot {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
      }

      #magnifier {
        position: absolute;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        border: 4px solid #ffffff;
        overflow: hidden;
        background: #000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        pointer-events: none;
        transform: translate(-50%, -50%);
        z-index: 100;
      }

      .pixel-grid {
        position: absolute;
        top: 0;
        left: 0;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        display: grid;
        grid-template-columns: repeat(9, 1fr);
        grid-template-rows: repeat(9, 1fr);
      }

      .pixel {
        border: 1px solid rgba(128, 128, 128, 0.4);
      }

      .pixel.center {
        border: 3px solid #ffffff;
        box-shadow:
          0 0 6px #000000,
          inset 0 0 4px rgba(255, 255, 255, 0.8);
        z-index: 10;
        position: relative;
      }

      #colorLabel {
        position: absolute;
        top: 160px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-family: Monaco, Consolas, monospace;
        pointer-events: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        z-index: 101;
        white-space: nowrap;
      }

      #instructions {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.75);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 102;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <canvas id="screenshot"></canvas>
    <div id="magnifier">
      <div class="pixel-grid" id="pixelGrid"></div>
    </div>
    <div id="colorLabel">
      <span id="colorName">Color</span>: <span id="hexCode">#FFFFFF</span>
    </div>
    <div id="instructions">Click to select color | ESC to cancel</div>

    <script>
      const { ipcRenderer } = require("electron");

      const screenshotCanvas = document.getElementById("screenshot");
      const ctx = screenshotCanvas.getContext("2d");
      const magnifier = document.getElementById("magnifier");
      const pixelGrid = document.getElementById("pixelGrid");
      const colorLabel = document.getElementById("colorLabel");
      const colorName = document.getElementById("colorName");
      const hexCode = document.getElementById("hexCode");

      let imageData = null;
      let currentColor = "#FFFFFF";

      console.log("[Fullscreen Picker] Script loaded");

      // Create 9x9 grid of pixels
      function createPixelGrid() {
        pixelGrid.innerHTML = "";
        for (let i = 0; i < 81; i++) {
          const pixel = document.createElement("div");
          pixel.className = "pixel";
          pixel.id = `pixel-${i}`;
          if (i === 40) {
            pixel.className += " center";
          }
          pixelGrid.appendChild(pixel);
        }
      }

      createPixelGrid();

      // Initialize with screenshot data
      ipcRenderer.on("init-screenshot", (event, data) => {
        console.log("[Fullscreen Picker] Received screenshot data");
        const { width, height, dataURL } = data;

        console.log(`[Fullscreen Picker] Loading image: ${width}x${height}`);
        console.log(
          `[Fullscreen Picker] Data URL length: ${dataURL ? dataURL.length : "undefined"}`,
        );
        console.log(
          `[Fullscreen Picker] Data URL starts with: ${dataURL ? dataURL.substring(0, 50) : "undefined"}`,
        );

        if (!dataURL) {
          console.error("[Fullscreen Picker] No data URL received!");
          return;
        }

        // Load the image from data URL
        const img = new Image();
        img.onload = () => {
          console.log("[Fullscreen Picker] Image loaded successfully");
          console.log(
            `[Fullscreen Picker] Image natural size: ${img.naturalWidth}x${img.naturalHeight}`,
          );

          // Set canvas size to match screenshot
          screenshotCanvas.width = width;
          screenshotCanvas.height = height;

          // Draw the image to canvas
          ctx.drawImage(img, 0, 0);

          // Get the image data for pixel reading
          imageData = ctx.getImageData(0, 0, width, height);

          console.log(
            `[Fullscreen Picker] Screenshot rendered: ${width}x${height}`,
          );
          console.log(
            `[Fullscreen Picker] First pixel: R=${imageData.data[0]} G=${imageData.data[1]} B=${imageData.data[2]}`,
          );

          // Signal ready
          ipcRenderer.send("magnifier-ready");
        };

        img.onerror = (err) => {
          console.error("[Fullscreen Picker] Failed to load image:", err);
        };

        img.src = dataURL;
      });

      // Get color at position from cached image data
      function getColorAt(x, y) {
        if (!imageData) return null;

        const ix = Math.floor(x);
        const iy = Math.floor(y);

        if (
          ix < 0 ||
          iy < 0 ||
          ix >= imageData.width ||
          iy >= imageData.height
        ) {
          return null;
        }

        const index = (iy * imageData.width + ix) * 4;
        const r = imageData.data[index];
        const g = imageData.data[index + 1];
        const b = imageData.data[index + 2];
        const hex =
          `#${r.toString(16).padStart(2, "0")}${g.toString(16).padStart(2, "0")}${b.toString(16).padStart(2, "0")}`.toUpperCase();

        return { r, g, b, hex };
      }

      // Simple nearest color lookup (basic implementation)
      function getColorName(r, g, b) {
        // This will be enhanced by the main process if needed
        return "Color";
      }

      // Update magnifier position and colors
      function updateMagnifier(mouseX, mouseY) {
        // Position magnifier at cursor
        magnifier.style.left = mouseX + "px";
        magnifier.style.top = mouseY + "px";

        // Position color label below magnifier
        colorLabel.style.left = mouseX + "px";
        colorLabel.style.top = mouseY + 85 + "px";

        // Get center color
        const centerColor = getColorAt(mouseX, mouseY);
        if (!centerColor) return;

        currentColor = centerColor.hex;
        hexCode.textContent = centerColor.hex;

        // Request color name from main process
        ipcRenderer.send("get-color-name", {
          r: centerColor.r,
          g: centerColor.g,
          b: centerColor.b,
        });

        // Update 9x9 pixel grid
        const halfSize = 4;
        let pixelIndex = 0;
        for (let row = 0; row < 9; row++) {
          for (let col = 0; col < 9; col++) {
            const px = mouseX - halfSize + col;
            const py = mouseY - halfSize + row;
            const pixelColor = getColorAt(px, py);
            const pixel = document.getElementById(`pixel-${pixelIndex}`);
            if (pixel) {
              pixel.style.backgroundColor = pixelColor
                ? pixelColor.hex
                : "#808080";
            }
            pixelIndex++;
          }
        }
      }

      // Receive color name from main process
      ipcRenderer.on("color-name-result", (event, name) => {
        colorName.textContent = name;
      });

      // Track mouse movement
      document.addEventListener("mousemove", (e) => {
        updateMagnifier(e.clientX, e.clientY);
      });

      // Handle clicks - select color
      document.addEventListener("click", (e) => {
        console.log("[Fullscreen Picker] Color selected:", currentColor);
        ipcRenderer.send("color-selected", currentColor);
      });

      // Handle escape - cancel
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          console.log("[Fullscreen Picker] Cancelled");
          ipcRenderer.send("picker-cancelled");
        }
      });

      // Initial position at center
      window.addEventListener("load", () => {
        const centerX = window.innerWidth / 2;
        const centerY = window.innerHeight / 2;
        updateMagnifier(centerX, centerY);
      });

      window.focus();
    </script>
  </body>
</html>
